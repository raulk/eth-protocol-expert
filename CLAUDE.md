<claude-mem-context>
# Recent Activity

<!-- This section is auto-generated by claude-mem. Edit content outside the tags. -->

### Jan 7, 2026

| ID | Time | T | Title | Read |
|----|------|---|-------|------|
| #1321 | 9:15 PM | ðŸ”µ | Project Dependencies for Phases 0-2 | ~410 |
| #1316 | 9:14 PM | ðŸ”µ | Full Implementation Plan Context Loaded | ~570 |
| #1315 | " | ðŸ”µ | Context Retrieval for Phases 3-6 Implementation | ~372 |
| #1314 | 9:13 PM | ðŸ”µ | Implementation Plan Review for Phases 3-6 | ~410 |
| #1027 | 6:22 PM | ðŸŸ£ | Python Project Configuration for Phases 0-2 | ~494 |
| #667 | 4:23 PM | ðŸŸ£ | Comprehensive 14-Phase Implementation Plan with Progressive Intelligence Levels | ~906 |
| #648 | 4:18 PM | ðŸ”µ | Detailed Phase Deliverables and Validation Criteria | ~742 |
| #647 | " | ðŸ”µ | Seven-Phase Implementation Roadmap Defined | ~500 |
| #645 | 4:17 PM | ðŸ”µ | Ethereum Protocol Intelligence System Architecture Specification | ~691 |
</claude-mem-context>

# Ethereum Protocol Intelligence System

RAG system for Ethereum protocol documentation with citation validation.

## Project overview

This is a 14-phase RAG (Retrieval-Augmented Generation) system that answers questions about Ethereum Improvement Proposals (EIPs). All phases (0-13) are implemented.

**Core pipeline:** Ingest EIPs â†’ Chunk â†’ Embed â†’ Store â†’ Retrieve â†’ Generate â†’ Validate

## Key commands

```bash
# Start database
docker compose up -d

# Ingest all EIPs
uv run python scripts/ingest_eips.py

# Query the system
uv run python scripts/query_cli.py "What is EIP-1559?" --mode simple
uv run python scripts/query_cli.py "What is EIP-1559?" --mode cited
uv run python scripts/query_cli.py "What is EIP-1559?" --mode validated

# Run tests
uv run pytest tests/ -v
uv run python scripts/test_e2e.py

# Lint and format
uv run ruff check . --fix
uv run ruff format .
```

## Architecture

```
src/
â”œâ”€â”€ ingestion/      # EIP loading, parsing, extended corpus loaders
â”œâ”€â”€ chunking/       # Fixed, section-aware, and code chunking
â”œâ”€â”€ embeddings/     # Voyage AI, local BGE, code embeddings
â”œâ”€â”€ storage/        # PostgreSQL + pgvector
â”œâ”€â”€ retrieval/      # Vector similarity search
â”œâ”€â”€ generation/     # Simple, cited, validated, synthesis generators
â”œâ”€â”€ validation/     # NLI claim verification, decomposition
â”œâ”€â”€ evidence/       # Evidence spans and ledgers
â”œâ”€â”€ concepts/       # Alias tables, query expansion (Phase 7)
â”œâ”€â”€ agents/         # ReAct agents, budget enforcement (Phase 8)
â”œâ”€â”€ structured/     # Timelines, argument maps (Phase 9)
â”œâ”€â”€ graph/          # EIP dependencies, cross-references (Phases 4, 11, 13)
â”œâ”€â”€ ensemble/       # Cost routing, multi-model (Phase 12)
â”œâ”€â”€ parsing/        # Tree-sitter code analysis (Phase 13)
â””â”€â”€ api/            # FastAPI endpoints
```

## Module conventions

### Imports

Use absolute imports from `src`:
```python
from src.chunking import FixedChunker, SectionChunker
from src.embeddings import VoyageEmbedder
from src.storage import PgVectorStore
from src.retrieval import SimpleRetriever
from src.generation import SimpleGenerator, CitedGenerator, ValidatedGenerator
```

### Async patterns

- Database operations are async (use `await`)
- Embedding is sync (VoyageEmbedder.embed_chunks returns directly)
- Generation uses `asyncio.to_thread` for Claude API calls

```python
# Correct pattern
store = PgVectorStore()
await store.connect()
chunks = chunker.chunk_eip(parsed)  # sync
embedded = embedder.embed_chunks(chunks)  # sync
await store.store_embedded_chunks(embedded)  # async
```

### Dataclasses

Key dataclasses to know:

| Class | Module | Purpose |
|-------|--------|---------|
| `LoadedEIP` | ingestion | Raw EIP from filesystem |
| `ParsedEIP` | ingestion | Parsed with frontmatter |
| `Chunk` | chunking | Text chunk with metadata |
| `EmbeddedChunk` | embeddings | Chunk with vector |
| `SearchResult` | retrieval | Chunk with similarity score |
| `RetrievalResult` | retrieval | Collection of search results |
| `GenerationResult` | generation | Response with metadata |
| `EvidenceSpan` | evidence | Immutable source reference |
| `Claim` | evidence | Extracted claim from response |

## Database

PostgreSQL with pgvector extension. Schema:

- `documents` - EIP metadata (number, title, status, type, category)
- `chunks` - Text chunks with embeddings (1024-dim vectors)

```bash
# Connection
DATABASE_URL=postgresql://postgres:<password>@localhost:5432/eth_protocol

# Reset database
docker compose down -v && docker compose up -d
```

## Environment variables

Required in `.env`:
```
VOYAGE_API_KEY=...       # Voyage AI for embeddings
ANTHROPIC_API_KEY=...    # Anthropic for generation
POSTGRES_PASSWORD=...    # Database password
```

## Testing

```bash
# Unit tests
uv run pytest tests/ -v

# End-to-end (requires database)
uv run python scripts/test_e2e.py

# Full RAG pipeline
uv run python scripts/test_full_rag.py
```

## Common tasks

### Add a new EIP source

1. Create loader in `src/ingestion/` (follow `eip_loader.py` pattern)
2. Add parser if needed
3. Export from `src/ingestion/__init__.py`

### Add a new generator mode

1. Create in `src/generation/` (extend base pattern)
2. Add to `src/generation/__init__.py`
3. Add mode to `scripts/query_cli.py`

### Add a new chunking strategy

1. Create in `src/chunking/`
2. Implement `chunk_eip(parsed: ParsedEIP) -> list[Chunk]`
3. Export from `src/chunking/__init__.py`

## Important notes

### NLI validation

Default model is `facebook/bart-large-mnli` (public, no auth).
For better quality, use `microsoft/deberta-v3-large-mnli` (requires HF login).

### Embedding dimensions

- Voyage AI (voyage-3): 1024 dimensions
- Local BGE: 1024 dimensions
- Code embeddings (voyage-code-2): 1536 dimensions

### API field names

- `SearchResult.similarity` (not `score`)
- `GenerationResult.response` (not `answer`)
- `RetrievalResult.results` (list of SearchResult)

## File locations

| Purpose | Location |
|---------|----------|
| Main CLI | `scripts/query_cli.py` |
| Ingestion | `scripts/ingest_eips.py` |
| Database schema | `src/storage/pg_vector_store.py` |
| API server | `src/api/main.py` |
| Implementation plan | `IMPLEMENTATION_PLAN.md` |
| Full spec | `SPEC.md` |

## Phase summary

| Phase | Module | Key classes |
|-------|--------|-------------|
| 0-2 | generation | SimpleGenerator, CitedGenerator, ValidatedGenerator |
| 3 | retrieval | HybridRetriever (BM25 + vector) |
| 4 | graph | EIPGraphBuilder, DependencyTraverser |
| 5 | routing | QueryDecomposer |
| 6 | ingestion | MagiciansLoader, EthresearchLoader |
| 7 | concepts | AliasTable, QueryExpander, ConceptResolver |
| 8 | agents | ReactAgent, BudgetEnforcer, Backtracker |
| 9 | structured | TimelineBuilder, ArgumentMapper, ComparisonBuilder |
| 10 | ingestion | ACDTranscriptLoader, ArxivFetcher, PDFExtractor |
| 11 | graph | RelationshipInferrer, ConfidenceScorer |
| 12 | ensemble | CostRouter, MultiModelRunner |
| 13 | parsing | TreeSitterParser, SpecImplLinker |
